"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[700],{1307:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"commands/git-hosting-backup","title":"git-hosting-backup","description":"% git-hosting-backup(1) Version 0.1.3 | Backing up Git Hosted Repo","source":"@site/docs/commands/git-hosting-backup.md","sourceDirName":"commands","slug":"/commands/git-hosting-backup","permalink":"/giture/docs/commands/git-hosting-backup","draft":false,"unlisted":false,"editUrl":"https://github.com/gerardnico/giture/tree/main/docs/commands/git-hosting-backup.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"git-feature-squash","permalink":"/giture/docs/commands/git-feature-squash"},"next":{"title":"git-hosting-env","permalink":"/giture/docs/commands/git-hosting-env"}}');var t=s(4848),r=s(8453);const o={},c="DESCRIPTION",a={},l=[{value:"Backup Github Repos to S3",id:"backup-github-repos-to-s3",level:2},{value:"Backup Github Repos to SFTP Bunny",id:"backup-github-repos-to-sftp-bunny",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"% git-hosting-backup(1) Version 0.1.3 | Backing up Git Hosted Repo"}),"\n",(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"description",children:"DESCRIPTION"})}),"\n",(0,t.jsxs)(n.p,{children:["This ",(0,t.jsx)(n.code,{children:"git-hosting-backup"})," command back up Git repositories:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["from ",(0,t.jsx)(n.code,{children:"GitHub"})]}),"\n",(0,t.jsxs)(n.li,{children:["to a ",(0,t.jsx)(n.a,{href:"https://rclone.org/overview/",children:"Rclone destination"})]}),"\n",(0,t.jsxs)(n.li,{children:["as a ",(0,t.jsx)(n.a,{href:"https://git-scm.com/book/en/v2/Git-Tools-Bundling",children:"Git bundle"})]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"example",children:"Example"}),"\n",(0,t.jsx)(n.h2,{id:"backup-github-repos-to-s3",children:"Backup Github Repos to S3"}),"\n",(0,t.jsx)(n.p,{children:"To back up your repositories:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"from github"}),"\n",(0,t.jsx)(n.li,{children:"to s3"}),"\n",(0,t.jsxs)(n.li,{children:["excluding the repo ",(0,t.jsx)(n.code,{children:"site-com-datacadamia"}),"\nyou would execute:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"docker run \\\n  --name git-hosting-backup \\\n  --rm \\\n  --user 1000:1000 \\\n  -v ~/.ssh:/home/me/.ssh \\\n  -e GITURE_GITHUB_TOKEN=$GITHUB_TOKEN \\\n  -e GITURE_S3_PLATFORM=rclone \\\n  -e GITURE_S3_RCLONE_BASE_PATH=git-backup \\\n  -e RCLONE_CONFIG_S3_TYPE=s3 \\\n  -e RCLONE_CONFIG_S3_PROVIDER=IDrive \\\n  -e RCLONE_CONFIG_S3_ENDPOINT=h0k0.ca.idrivee2-22.com \\\n  -e RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$GIT_BACKUP_SECRET_KEY \\\n  -e RCLONE_CONFIG_S3_ACCESS_KEY_ID=$GIT_BACKUP_ACCESS_KEY \\\n  -e RCLONE_CONFIG_S3_NO_CHECK_BUCKET=true \\\n  -e RCLONE_CONFIG_S3_SERVER_SIDE_ENCRYPTION=aws:kms \\\n  ghcr.io/gerardnico/giture:latest \\\n  git-hosting-backup github s3 --filter-exclude-pattern=site-com-datacadamia\n"})}),"\n",(0,t.jsx)(n.h2,{id:"backup-github-repos-to-sftp-bunny",children:"Backup Github Repos to SFTP Bunny"}),"\n",(0,t.jsx)(n.p,{children:"To back up your repositories:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"from github"}),"\n",(0,t.jsxs)(n.li,{children:["to Bunny with ",(0,t.jsx)(n.a,{href:"https://rclone.org/sftp/",children:"Rclone SFTP"})]}),"\n",(0,t.jsxs)(n.li,{children:["excluding the repo ",(0,t.jsx)(n.code,{children:"site-com-datacadamia"}),"\nyou would execute:"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"docker run \\\n  --name git-backup \\\n  --rm \\\n  --user 1000:1000 \\\n  -v ~/.ssh:/home/me/.ssh \\\n  -e GITURE_GITHUB_TOKEN=$GITHUB_TOKEN \\\n  -e GITURE_BUNNY_PLATFORM=rclone \\\n  -e RCLONE_INPLACE=1 \\\n  -e RCLONE_SIZE_ONLY=1 \\\n  -e RCLONE_CONFIG_BUNNY_TYPE=sftp \\\n  -e RCLONE_CONFIG_BUNNY_HOST=storage.bunnycdn.com \\\n  -e RCLONE_CONFIG_BUNNY_ENDPOINT=h0k0.ca.idrivee2-22.com \\\n  -e RCLONE_CONFIG_BUNNY_USER=git-backup \\\n  -e RCLONE_CONFIG_BUNNY_PASS=$GIT_BACKUP_BUNNY_PASS \\\n  ghcr.io/gerardnico/giture:latest \\\n  git-hosting-backup github bunny --filter-exclude-pattern=site-com-datacadamia\n"})}),"\n",(0,t.jsx)(n.p,{children:"Note that:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"RCLONE_INPLACE=1"})," is needed\nbecause ",(0,t.jsx)(n.a,{href:"https://support.bunny.net/hc/en-us/articles/360020400891-I-am-unable-to-rename-files-using-FTP",children:"Bunny does not support renaming"}),"\nLeading to error such as\n",(0,t.jsx)(n.code,{children:'partial file rename failed: Move Rename failed: sftp: "Internal server error." (SSH_FX_FAILURE)'})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"RCLONE_SIZE_ONLY=1"})," is needed because Bunny does not support modification time update."]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"example-explanation",children:"Example Explanation"}),"\n",(0,t.jsx)(n.p,{children:"The command executed is:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"git-hosting-backup github s3 --filter-exclude-pattern=site-com-datacadamia\n"})}),"\n",(0,t.jsx)(n.p,{children:"where:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"backup"})," is the command"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"github"})," is the service defined by the following ",(0,t.jsx)(n.code,{children:"GITURE_SERVICE_NAME_xxx"})," envs)"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"GITURE_GITHUB_PLATFORM=github # platform type (optional as it defaults to the name)\nGITURE_GITHUB_TOKEN=$GITHUB_TOKEN # API Token\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"s3"})," is the target defined by the following ",(0,t.jsx)(n.code,{children:"GITURE_PLATFORM_NAME_xxx"})," envs"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"GITURE_S3_PLATFORM=rclone # rclone\nGITURE_S3_RCLONE_REMOTE_NAME=s3 # optional remote name, by default, the target registry name (only characters and _ as this an env),\nGITURE_S3_RCLONE_BASE_PATH=git-backup # the base path (in our s3 case, the bucket name)\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--filter-exclude-pattern=xxx"})," is a regexp pattern that if the expression matches the full name repository (\n",(0,t.jsx)(n.code,{children:"workspace/name"}),") will exclude it from backup"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The rclone remote name is configured\nvia ",(0,t.jsx)(n.a,{href:"https://rclone.org/docs/#environment-variables",children:"the native rclone environment variable"}),".\nie ",(0,t.jsx)(n.code,{children:"RCLONE_CONFIG_REMOTE_NAME_XXX"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# in our case the GIT_BACKUP remote name was defined via the env `GITURE_S3_RCLONE_REMOTE_NAME=git_backup`\nRCLONE_CONFIG_S3_TYPE=s3\nRCLONE_CONFIG_S3_PROVIDER=IDrive\nRCLONE_CONFIG_S3_ENDPOINT=h0k0.ca.idrivee2-22.com\nRCLONE_CONFIG_S3_SECRET_ACCESS_KEY=$GIT_BACKUP_SECRET_KEY\nRCLONE_CONFIG_S3_ACCESS_KEY_ID=$GIT_BACKUP_ACCESS_KEY\nRCLONE_CONFIG_S3_NO_CHECK_BUCKET=true\nRCLONE_CONFIG_S3_SERVER_SIDE_ENCRYPTION=aws:kms\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"The env below mount your SSH directory for a GitHub authentication"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"--user 1000:1000 \\\n-v ~/.ssh:/home/me/.ssh\n"})}),"\n",(0,t.jsx)(n.h1,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["SSH Authentication:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["An SSH private key in your ",(0,t.jsx)(n.code,{children:"~/.ssh"})," directory.\nie ",(0,t.jsx)(n.a,{href:"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent",children:"Generate a key"})]}),"\n",(0,t.jsx)(n.li,{}),"\n"]}),"\n","With ",(0,t.jsx)(n.a,{href:"https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account",children:"the corresponding public key added to GitHub"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens",children:"A GitHub API Token"}),"\nknown as Personal Access Token or PAT","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["with the scope ",(0,t.jsx)(n.code,{children:"repo"})," for public and private repo"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.a,{href:"https://rclone.org/overview/",children:"Rclone destination"})]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.a,{href:"#dependencies",children:"dependencies"})]}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"synopsis",children:"SYNOPSIS"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"git-hosting-backup source target [...]\n"})}),"\n",(0,t.jsx)(n.p,{children:"where:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"source                       - a git hosting service name to read from"}),"\n",(0,t.jsx)(n.li,{children:"target                       - a target name to backup to"}),"\n",(0,t.jsx)(n.li,{children:"--output                     - the statistics output format (json or prometheus). Default to json"}),"\n",(0,t.jsx)(n.li,{children:"--restart                    - if a backup fail, it can be restarted with the restart flag"}),"\n",(0,t.jsx)(n.li,{children:"--filter-exclude-pattern=xxx - a regexp pattern to exclude from applied on the repository full name (ie parent/name)"}),"\n",(0,t.jsx)(n.li,{children:"--filter-max-repo-count='x'  - the maximum number of repositories to process"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This script returns the following statistiques:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"total_repo_count"})," is the number of repositories processed (up to max-repo-count option)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"dumped_repo_count"})," is the number of repositories bundled (ie dumped)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"unchanged_repo_count"})," is the number of repositories skipped because of no changes since the last dump"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"pattern_repo_count"})," is the number of repositories skipped due to pattern matching"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"empty_repo_count"})," is the number of repositories skipped due to being empty"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"fork_repo_count"})," is the number of repositories skipped due to being a fork"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Note:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"total = dumped + unchanged + pattern + empty + fork\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Tip: You can process the json format further with ",(0,t.jsx)(n.code,{children:"jq"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"git-hosting-backup source target | jq -r '.total_repo_count .dumped_repo_count'\n"})}),"\n",(0,t.jsx)(n.h1,{id:"how-to-restore",children:"How to restore"}),"\n",(0,t.jsxs)(n.p,{children:["A ",(0,t.jsx)(n.a,{href:"https://git-scm.com/book/en/v2/Git-Tools-Bundling",children:"bundle"})," can be cloned."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"git clone /path/to/repo.bundle\n# or\ngit clone https://host/path/to/repo.bundle\n"})}),"\n",(0,t.jsx)(n.h1,{id:"backup-processing-explained",children:"Backup processing explained"}),"\n",(0,t.jsxs)(n.p,{children:["The backup processing implemented in the ",(0,t.jsx)(n.code,{children:"backup"})," function of the ",(0,t.jsx)(n.a,{href:"/giture/docs/commands/git-hosting",children:"git-hosting script"})," is:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Store the start time and get the last backup time"}),"\n",(0,t.jsxs)(n.li,{children:["Get the repos via API and loop over them","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Skip the backup if:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"the last pushed time of the repo is earlier than the last backup (and if a backup exist)"}),"\n",(0,t.jsx)(n.li,{children:"the repository is empty"}),"\n",(0,t.jsx)(n.li,{children:"the repository is a fork"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"Otherwise, backup with the following commands:"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# git clone a mirror repository locally\ngit clone --mirror REPO_SSH_URL CLONE_TARGET_DIR\n# create a bundle\ngit bundle create BUNDLE_SOURCE_PATH --all\n# upload the bundle to `workspace/repository_name`\nrclone moveto BUNDLE_SOURCE_PATH BUNDLE_TARGET_PATH --progress\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Repeat for another repo"}),"\n",(0,t.jsx)(n.li,{children:"Delete the start time"}),"\n",(0,t.jsx)(n.li,{children:"Write the last time with the start time"}),"\n",(0,t.jsx)(n.li,{children:"End"}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"tip-how-to-sync-between-2-git-registries",children:"Tip: How to sync between 2 git registries"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.a,{href:"https://cooperspencer.github.io/gickup-documentation/",children:"Gickup application"})," is more suited for that."]}),"\n",(0,t.jsx)(n.h1,{id:"why-do-you-choose-ssh-over-personal-access-token-for-github",children:"Why do you choose SSH over Personal Access Token for Github"}),"\n",(0,t.jsx)(n.p,{children:"That's the easiest way to login."}),"\n",(0,t.jsxs)(n.p,{children:["Note that AskPass or a helper may be used to pass the token\nas stated in the ",(0,t.jsx)(n.a,{href:"https://git-scm.com/docs/gitcredentials",children:"doc"}),", but it's not yet implemented"]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"Personal Access Token (PAT)"})," should not be used in a Basic Auth URL as this URL is stored"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"https://user:$TOKEN/github.com/parent/repo\n"})}),"\n",(0,t.jsx)(n.h1,{id:"kubernetes",children:"Kubernetes"}),"\n",(0,t.jsxs)(n.p,{children:["In the ",(0,t.jsx)(n.code,{children:"command"})," property of a container, you should use the entrypoint ",(0,t.jsx)(n.code,{children:"giture-docker-entrypoint"}),"\nto create the ",(0,t.jsx)(n.code,{children:"host_known"})," file with GitHub SSH keys and avoid the error: ",(0,t.jsx)(n.code,{children:"Host key verification failed"})]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'command: [ "giture-docker-entrypoint" ]\nargs: [ "git-backup", "backup", "github", "s3", "--filter-exclude-pattern=site-com-datacadamia", "--restart" ]\n'})}),"\n",(0,t.jsx)(n.h1,{id:"dependencies",children:"Dependencies"}),"\n",(0,t.jsx)(n.p,{children:"We use the following dependencies are"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Date from coreutils mandatory"}),"\n",(0,t.jsx)(n.li,{children:"git"}),"\n",(0,t.jsx)(n.li,{children:"openssh"}),"\n",(0,t.jsx)(n.li,{children:"curl"}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var i=s(6540);const t={},r=i.createContext(t);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);