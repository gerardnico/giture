#!/bin/bash
# Delete a feature branch, see md file for documentation

set -Eeuo pipefail

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  # This is also a valid path for brew
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-string.sh
source "bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"

function synopsis() {

  cat << EOF
Delete a feature branch

\`\`\`bash
$(basename "$0") [ -f | --force ] branch-name
\`\`\`

* \`-f | --force\` : pass the commit difference error (if the feature branch was squashed merge for instance)
EOF
}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

# Args parsing
BRANCH_NAME=""
FORCE_DELETE=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -f | --force)
      FORCE_DELETE=true
      ;;
    *)
      BRANCH_NAME=${1}
      shift
      break
      ;;
  esac
  shift
done

if [[ "${BRANCH_NAME}" == "" ]]; then
  BRANCH_NAME=$(git::get_current_branch)
fi

# branch protection
DEFAULT_BRANCH=$(git::get_default_branch)
if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
  echo::error "You can't delete the default branch ($DEFAULT_BRANCH)"
  exit 1
fi

if ! git::branch_exists "$BRANCH_NAME"; then
  echo::warn "The branch $BRANCH_NAME was not found"
  exit 1
fi

command::echo_eval "git checkout $BRANCH_NAME"

echo::info "Check if branch $BRANCH_NAME is dirty"
command::echo_eval "git checkout $BRANCH_NAME"

if git::is_dirty_index; then
  echo::error "The branch is dirty, stash or rollback your changes"
  exit 1
fi

# Checkout to the default branch
DEFAULT_BRANCH=$(git::get_default_branch)
echo::info "Checkout to the default branch $DEFAULT_BRANCH"
command::echo_eval "git checkout $DEFAULT_BRANCH"

# Commit check
if [ $FORCE_DELETE == false ]; then
  # Before deletion, check that all feature commits are in the main branch
  COMMIT_DIFF=$(git log "$DEFAULT_BRANCH".."$BRANCH_NAME")
  if [ "$COMMIT_DIFF" != "" ]; then
    echo::err "Not all commits from $BRANCH_NAME are in the default branch $DEFAULT_BRANCH"
    echo::err "$COMMIT_DIFF"
    echo::err "Use the --force option (if you don't care. For instance, if the branch was squashed merged)"
    exit 1
  fi
fi

# Delete
echo::info "Delete branch $BRANCH_NAME locally"
command::echo_eval "git branch -D $BRANCH_NAME"
echo::info "Delete branch $BRANCH_NAME Remotely"
command::echo_eval "git push origin --delete  $BRANCH_NAME"
echo::success "Done"
