#!/usr/bin/env bash
# Merge a feature branch

set -Eeuo pipefail

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  # This is also a valid path for brew
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-string.sh
source "bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"

function synopsis() {

  cat << EOF
Merge a feature branch
\`\`\`bash
$(basename "$0") commit message
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

BRANCH_NAME=$(git::get_current_branch)
DEFAULT_BRANCH=$(git::get_default_branch)
if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
  echo::error "It's not a feature branch, it's the default branch ($DEFAULT_BRANCH)"
  echo::error "You can't merge the default branch"
  exit 1
fi

echo::info "Check if branch $BRANCH_NAME is dirty"
command::echo_eval "git checkout $BRANCH_NAME"
if git::is_dirty_index; then
  echo::err "The branch is dirty, commit, stash or rollback your changes"
  exit 1
fi

# Go to the default branch
echo::info "Checkout to the default branch $DEFAULT_BRANCH"
command::echo_eval "git checkout $DEFAULT_BRANCH"

#echo::info "Pull from $DEFAULT_BRANCH"
#command::echo_eval "git pull origin $DEFAULT_BRANCH"

COMMIT_COUNT=$(git rev-list --count "$DEFAULT_BRANCH".."$BRANCH_NAME")
if [ "$COMMIT_COUNT" == "1" ]; then
  # Only one commit to merge
  command::echo_eval "git merge $BRANCH_NAME"
  command::echo_eval "git push"
  echo::success "Done"
  echo::tip "Delete feature with:"
  echo::tip "   git-feature-delete $BRANCH_NAME"
  exit
fi

# The --squash option takes all the commits and condenses them into one WIP index on main
echo::info "Merge squash the $BRANCH_NAME"
command::echo_eval "git merge --no-recurse-submodules --squash $BRANCH_NAME"
if ! git-prepare; then
  echo::warn "Commit hooks have failed"
  echo::warn "Check the error and commit against $DEFAULT_BRANCH"
  exit 1
fi
COMMIT_MESSAGE=${1:-"feat: merge feature branch $BRANCH_NAME"}
echo::info "Commit"
SCISSOR_LINE="# ------------------------ >8 ------------------------"
# All subject and body, we delete empty line because if the body (b) is empty we get an empty line
BODY=$(git log --pretty=format:%s%n%b "$DEFAULT_BRANCH".."$BRANCH_NAME" | sed 's/[^:]*: /  - /' | sed '/^[[:space:]]*$/d')
MESSAGE=$(
  cat <<- HereDoc
$COMMIT_MESSAGE

$BODY
$SCISSOR_LINE
HereDoc
)
# Commit with edit message
git-commit --edit "$MESSAGE"
echo::success "Done"
echo::tip "Delete branch with:"
echo::tip "   git-branch-delete $BRANCH_NAME"
