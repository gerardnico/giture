#!/usr/bin/env bash
# Merge a feature branch

set -Eeuo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  # This is also a valid path for brew
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-string.sh
source "bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"

function synopsis() {

  cat << EOF
Merge a feature branch

\`\`\`bash
$(basename "$0") [options] [commit message]
\`\`\`

  Options:
    * \`--recurse\` or \`-r\`    : recurse in the submodules

EOF

}

BRANCH_NAME=$(git::get_current_branch)
COMMIT_MESSAGE=${1:-"feat: merge feature branch $BRANCH_NAME"}
RECURSE=false
ORIGINAL_ARGS=("$@")
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help | help)
      # Help
      doc::help synopsis
      exit 0
      ;;
    synopsis)
      # Doc Synopsis
      synopsis
      exit 0
      ;;
    -r | --recurse)
      RECURSE=true
      ;;
    *)
      doc::help synopsis
      echo::err "The argument ($1) was unexpected"
      exit 1
      ;;
  esac
  shift
done

# First submodules
# If not in a submodule (in a submodule .git is a file)
# Otherwise the commit is only for the submodule
if [ $RECURSE == true ] && [ ! -f .git ]; then

  # script dir is mandatory because we may call the next version
  # and the git-xxxx command in the PATH env var is generally the actual version
  CMD="$SCRIPT_DIR/$(basename "$0")"
  # Quote the arguments otherwise you get space in message
  for ORIGINAL_ARG in "${ORIGINAL_ARGS[@]}"; do
    CMD+=" \"$ORIGINAL_ARG\""
  done
  if ! git submodule foreach "$CMD"; then
    echo::err "Error when executing $(basename "$0") to a submodule. Command: $CMD"
    exit 1
  fi

fi

# Status of the actual repo
if [ ! -f .git ]; then
  echo "Entering main repo"
fi

DEFAULT_BRANCH=$(git::get_default_branch)
if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
  echo::warn "It's not a feature branch, it's the default branch ($DEFAULT_BRANCH)"
  echo::warn "No commits merged"
  if [ $RECURSE == true ]; then
    # Spacing
    echo ""
  fi
  exit 0
fi

echo::info "Check if branch $BRANCH_NAME is dirty"
command::echo_eval "git checkout $BRANCH_NAME"
if git::is_dirty_index; then
  echo::err "The branch is dirty, commit, stash or rollback your changes"
  exit 1
fi

# Go to the default branch
echo::info "Checkout to the default branch $DEFAULT_BRANCH"
command::echo_eval "git checkout $DEFAULT_BRANCH"

#echo::info "Pull from $DEFAULT_BRANCH"
#command::echo_eval "git pull origin $DEFAULT_BRANCH"

COMMIT_COUNT=$(git rev-list --count "$DEFAULT_BRANCH".."$BRANCH_NAME")

if [ "$COMMIT_COUNT" == "0" ]; then
  echo::success "No commits to merge into $DEFAULT_BRANCH"
  exit
fi

if [ "$COMMIT_COUNT" == "1" ]; then
  # Only one commit to merge
  command::echo_eval "git merge $BRANCH_NAME"
  command::echo_eval "git push"
  echo::success "Done"
  echo::tip "Delete feature with:"
  echo::tip "   git-feature-delete $BRANCH_NAME"

  if [ $RECURSE == true ]; then
    # Spacing
    echo ""
  fi

  exit
fi

echo::err "More than 1 commit to integrate: $COMMIT_COUNT"
echo::err "We don't support yet merging branch that have not been squashed to 1 commit with git-feature-squash"
exit 1
