#!/bin/bash
# for doc, see markdown file

set -Eeuo pipefail

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  # This is also a valid path for brew
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-string.sh
source "bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"

function synopsis() {

  cat << EOF
Squash all commits of a branch into one
\`\`\`bash
$(basename "$0") [commit message]
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

BRANCH_NAME=$(git::get_current_branch)
DEFAULT_BRANCH=$(git::get_default_branch)
if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
  echo::error "It's not a feature branch, it's the default branch ($DEFAULT_BRANCH)"
  echo::error "You can't squash the default branch"
  exit 1
fi

echo::info "Check if branch $BRANCH_NAME is dirty"
command::echo_eval "git checkout $BRANCH_NAME"
if git::is_dirty_index; then
  echo::err "The branch $BRANCH_NAME is dirty. Commit, stash or rollback your changes"
  exit 1
fi

# Message before the reset
COMMIT_MESSAGE=${1:-"feat: squash feature branch $BRANCH_NAME"}
echo::info "Commit"
BODY=$(git log --pretty=format:%s%n%b "$DEFAULT_BRANCH".."$BRANCH_NAME")
SCISSOR_LINE="# ------------------------ >8 ------------------------"
MESSAGE=$(
  cat <<- HereDoc
$COMMIT_MESSAGE

$BODY
$SCISSOR_LINE
HereDoc
)

# Reset
echo::info "Reset from $DEFAULT_BRANCH"
command::echo_eval "git reset --no-recurse-submodules --soft $DEFAULT_BRANCH"

# Commit with edit
# The git-prevent-out-of-sync-commit hooks would fail
# We disable git hooks
command::echo_eval "git commit --no-verify --edit -am \"$MESSAGE\""
# we push first so that we are in sync with the remote branch
# ie we don't need to pull change from the remote
# git hooks may fail if the remote is not in sync with the local branch
command::echo_eval "git push --force-with-lease"
echo::success "Done"
