#!/usr/bin/env bash

set -Eeuo pipefail

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  # This is also a valid path for brew
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"

function synopsis() {

  cat << EOF
\`\`\`bash
$(basename "$0")
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

function git_remote_sync_status() {

  # Upstream
  git fetch
  upstreamCommitToMerge=$(git::get_commits_ahead_of_upstream)
  localCommitToPush=$(git::get_commits_ahead_of_upstream)
  echo ""
  echo "Commit sync:"
  echo "  * $upstreamCommitToMerge commits to merge"
  echo "  * $localCommitToPush commits to push"

}

function github() {
  echo ""
  echo "GitHub Actions Run:"
  gh run list
  echo "Watch with: gh run watch"
  echo ""
  echo "Git Releases:"
  gh release list
}

function git_remote() {
  echo ""
  echo "Git Remote:"
  git remote -v
}

function main() {
  git_remote
  git_remote_sync_status
  github
}

main
