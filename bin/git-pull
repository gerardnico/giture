#!/usr/bin/env bash
# for doc, see md file

set -Eeuo pipefail

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  # This is also a valid path for brew
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-path.sh
source "bashlib-path.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"

# Synopsis
function synopsis() {

  cat << EOF
Easy AutoPull
\`\`\`bash
$(basename "$0")
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

DIRECTORY_NAME=$(path::get_current_directory_name)

# Stash before a merge to integrate the remote changes
# To avoid the error: Please commit your changes or stash them before you merge.
#
# Note that when the local changes do not conflict with the changes in the upstream,
# a simple git pull let you move forward but how do we know that ?
#
STASH=0
if git::is_dirty; then
  echo::info "$DIRECTORY_NAME - Working area dirty"
  STASH=1
else
  echo::info "$DIRECTORY_NAME - Working area not dirty"
fi

if [ "$STASH" = "1" ]; then
  echo::info "$DIRECTORY_NAME - Stashing the files $(git::get_dirty_files)"
  git stash
fi

echo::info "$DIRECTORY_NAME - Pulling"
git pull

if [ "$STASH" = "1" ]; then
  echo::info "$DIRECTORY_NAME - UnStashing"
  git stash pop # do a merge
fi
